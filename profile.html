<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Ram GOSSIP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --neon-cyan: #00f2fe; --neon-pink: #f472b6; --bg-dark: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: white; background: radial-gradient(circle at top right, #1e293b, #0f172a); overflow-x: hidden; }
        .glass-container { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-field { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(0, 242, 254, 0.3); outline: none; transition: all 0.3s ease; }
        .input-field:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0, 242, 254, 0.2); }
        .hide-view { display: none !important; }
        .stat-card { background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.05); }
        .btn-save { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative pb-32">

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[200] glass-container px-6 py-3 rounded-full border-cyan-500/50 hide-view transition-all duration-300">
        <span id="toast-msg" class="text-sm font-bold text-cyan-400"></span>
    </div>

    <section class="p-6 pt-10 text-center">
        <div class="relative inline-block mb-4">
            <div class="w-32 h-32 rounded-full border-4 border-cyan-400 p-1 shadow-[0_0_20px_rgba(0,242,254,0.3)] overflow-hidden">
                <img id="profile-img-display" src="logo.png" class="w-full h-full rounded-full object-cover">
            </div>
            <input type="file" id="gallery-input" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
            <button onclick="document.getElementById('gallery-input').click()" class="absolute bottom-0 right-0 bg-cyan-500 text-slate-900 w-10 h-10 rounded-full border-4 border-slate-900 flex items-center justify-center transition-transform active:scale-90">
                <i class="fa-solid fa-camera text-xs"></i>
            </button>
        </div>
        <h1 id="profile-name" class="text-2xl font-black tracking-tight">Loading...</h1>
        <p id="profile-admin" class="text-slate-500 text-[10px] font-black uppercase tracking-widest mt-1">Admin: ---</p>
        
        <div class="flex justify-center items-center space-x-2 mt-4">
            <p id="profile-bio" class="text-slate-400 text-sm italic leading-relaxed">"Spilling tea since Day 1 â˜•"</p>
            <button onclick="toggleEdit()" class="text-cyan-400/50 hover:text-cyan-400"><i class="fa-solid fa-pen-to-square text-xs"></i></button>
        </div>
    </section>

    <div id="edit-modal" class="fixed inset-0 z-[120] modal-overlay items-center justify-center p-6 hide-view flex">
        <div class="glass-container w-full rounded-[2.5rem] p-8 space-y-5 border-cyan-500/30 shadow-2xl">
            <h3 class="text-xl font-black text-cyan-400 text-center tracking-tighter uppercase">Update Vibe</h3>
            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-1 block">Your Bio</label>
                <textarea id="edit-bio" placeholder="What's your current status?" class="input-field w-full rounded-2xl p-4 text-white text-sm" rows="3"></textarea>
            </div>
            <div class="flex space-x-3 pt-2">
                <button onclick="toggleEdit()" class="flex-1 py-4 rounded-2xl border border-slate-700 text-slate-400 font-bold text-xs">CANCEL</button>
                <button onclick="saveProfile()" class="flex-1 btn-save py-4 rounded-2xl text-slate-900 font-black text-xs">SAVE</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[150] modal-overlay items-center justify-center p-6 hide-view flex">
        <div class="glass-container w-full max-w-[300px] rounded-[2rem] p-6 text-center space-y-6 border-pink-500/30 shadow-2xl">
            <h3 id="confirm-title" class="text-lg font-black text-white uppercase tracking-tighter">Are you sure?</h3>
            <p id="confirm-msg" class="text-xs text-slate-400 leading-relaxed"></p>
            <div class="flex space-x-3">
                <button onclick="closeConfirm()" class="flex-1 py-3 rounded-xl border border-slate-700 text-slate-400 font-bold text-[10px]">NO, WAIT</button>
                <button id="confirm-yes-btn" class="flex-1 bg-pink-500 py-3 rounded-xl text-white font-black text-[10px]">YES, PROCEED</button>
            </div>
        </div>
    </div>

    <section class="grid grid-cols-3 gap-3 px-6 py-4">
        <div class="stat-card rounded-2xl p-3 text-center border-l-2 border-pink-500">
            <span class="block text-xl font-black text-pink-500" id="stat-posts">0</span>
            <span class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Spilled</span>
        </div>
        <div class="stat-card rounded-2xl p-3 text-center border-l-2 border-cyan-400">
            <span class="block text-xl font-black text-cyan-400" id="stat-fires">0</span>
            <span class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Impact</span>
        </div>
        <div class="stat-card rounded-2xl p-3 text-center border-l-2 border-purple-500">
            <span class="block text-xl font-black text-purple-500">100%</span>
            <span class="text-[8px] text-slate-500 uppercase font-bold tracking-widest">Active</span>
        </div>
    </section>

    <section class="p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">My Tea History</h2>
            <button onclick="loadMyPosts()" class="text-cyan-400 transition-transform active:rotate-180"><i class="fa-solid fa-rotate text-xs"></i></button>
        </div>
        <div id="my-posts-container" class="space-y-4">
            <div class="text-center py-10 opacity-20">
                <i class="fa-solid fa-mug-hot animate-bounce text-3xl"></i>
                <p class="text-[10px] font-bold uppercase mt-2">Brewing your tea...</p>
            </div>
        </div>
        
        <button onclick="showLogoutConfirm()" class="w-full mt-12 py-5 rounded-[2rem] border border-pink-500/20 text-pink-500 font-black text-[10px] uppercase tracking-[0.2em] bg-pink-500/5 active:scale-95 transition-all">
            <i class="fa-solid fa-power-off mr-2"></i> End Session
        </button>
    </section>

    <nav class="fixed bottom-4 left-4 right-4 max-w-md mx-auto glass-container rounded-[2rem] flex justify-around items-center py-4 border border-white/10 z-50">
        <a href="index.html" class="flex flex-col items-center text-slate-500 hover:text-cyan-400">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[8px] mt-1 font-black uppercase">Home</span>
        </a>
        <a href="trending.html" class="flex flex-col items-center text-slate-500 hover:text-pink-400">
            <i class="fa-solid fa-bolt text-xl"></i>
            <span class="text-[8px] mt-1 font-black uppercase">Trends</span>
        </a>
        <div class="w-14 h-14 bg-slate-900 rounded-full flex items-center justify-center -mt-12 border-4 border-slate-900 shadow-xl overflow-hidden">
             <img id="nav-profile-pic" src="logo.png" class="w-full h-full object-cover">
        </div>
        <a href="ramtok.html" class="flex flex-col items-center text-slate-500 hover:text-cyan-400">
            <i class="fa-solid fa-video text-xl"></i>
            <span class="text-[8px] mt-1 font-black uppercase">Ramtok</span>
        </a>
        <a href="profile.html" class="flex flex-col items-center text-cyan-400">
            <i class="fa-solid fa-user text-xl"></i>
            <span class="text-[8px] mt-1 font-black uppercase">Profile</span>
        </a>
    </nav>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzb5FpETfVLJ_uyDj-LPhQnQ0QMhNjx8wvEOjY-mO_7H8bClROaLJnUVrltNDA5_gk/exec";
        let currentUser = JSON.parse(localStorage.getItem('ram_gossip_user'));

        function notify(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.classList.remove('hide-view');
            setTimeout(() => { toast.classList.add('hide-view'); }, 3000);
        }

        // --- CUSTOM MODAL HANDLERS ---
        function showConfirm(title, msg, onConfirm) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-yes-btn').onclick = () => { onConfirm(); closeConfirm(); };
            document.getElementById('confirm-modal').classList.remove('hide-view');
        }
        function closeConfirm() { document.getElementById('confirm-modal').classList.add('hide-view'); }

        window.onload = () => {
            if (!currentUser) return location.href = 'index.html';
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-admin').innerText = `Admin: ${currentUser.adminNo || '---'}`;
            if (currentUser.pic) {
                document.getElementById('profile-img-display').src = currentUser.pic;
                document.getElementById('nav-profile-pic').src = currentUser.pic;
            }
            if (currentUser.bio) document.getElementById('profile-bio').innerText = `"${currentUser.bio}"`;
            loadMyPosts();
        };

        // --- GALLERY UPLOAD SYSTEM ---
        function handleImageUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 1024 * 1024) return notify("Image too large! Max 1MB. ðŸ“¸");
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Image = e.target.result;
                    document.getElementById('profile-img-display').src = base64Image;
                    document.getElementById('nav-profile-pic').src = base64Image;
                    saveImageToDb(base64Image);
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveImageToDb(base64) {
            notify("Syncing photo...");
            try {
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'updateProfile', admin: currentUser.adminNo, picUrl: base64 }) 
                });
                if (await res.text() === "Success") {
                    currentUser.pic = base64;
                    localStorage.setItem('ram_gossip_user', JSON.stringify(currentUser));
                    notify("Photo updated! ðŸ“¸");
                }
            } catch (e) { notify("Upload failed."); }
        }

        async function loadMyPosts() {
            const container = document.getElementById('my-posts-container');
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'fetchMyPosts', user: currentUser.name })
                });
                const posts = await res.json();
                container.innerHTML = posts.length ? "" : `<p class="text-center text-slate-600 text-xs py-10 uppercase font-black">No tea spilled yet...</p>`;
                
                let totalImpact = 0;
                document.getElementById('stat-posts').innerText = posts.length;

                posts.forEach(post => {
                    totalImpact += post.likes;
                    const html = `
                        <div class="glass-container rounded-3xl p-5 border-l-4 ${post.anonymous ? 'border-pink-500' : 'border-cyan-500'}">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest">
                                    ${post.anonymous ? '<i class="fa-solid fa-user-secret"></i> Anonymous' : '<i class="fa-solid fa-globe"></i> Public'}
                                </span>
                                <button onclick="showDeleteConfirm('${post.id}')" class="text-slate-700 hover:text-pink-500"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                            <p class="text-slate-200 text-sm leading-relaxed">${post.content}</p>
                            <div class="mt-4 pt-3 border-t border-white/5 flex justify-between items-center">
                                <span class="text-[8px] text-slate-600 font-bold">${new Date(post.time).toLocaleDateString()}</span>
                                <span class="text-pink-500 text-[10px] font-black"><i class="fa-solid fa-fire mr-1"></i>${post.likes}</span>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', html);
                });
                document.getElementById('stat-fires').innerText = totalImpact;
            } catch (e) { notify("Sync error."); }
        }

        function toggleEdit() { 
            const modal = document.getElementById('edit-modal');
            modal.classList.toggle('hide-view');
            if(!modal.classList.contains('hide-view')) {
                document.getElementById('edit-bio').value = currentUser.bio || "";
            }
        }

        async function saveProfile() {
            const bio = document.getElementById('edit-bio').value;
            notify("Syncing...");
            try {
                const res = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'updateProfile', admin: currentUser.adminNo, bio: bio }) 
                });
                if (await res.text() === "Success") {
                    currentUser.bio = bio;
                    localStorage.setItem('ram_gossip_user', JSON.stringify(currentUser));
                    document.getElementById('profile-bio').innerText = `"${bio}"`;
                    toggleEdit();
                    notify("Vibe Updated! âœ¨");
                }
            } catch (e) { notify("Update failed."); }
        }

        function showDeleteConfirm(id) {
            showConfirm("Delete Tea?", "This will erase the gossip from the class files permanently. No turning back!", () => executeDelete(id));
        }

        async function executeDelete(postId) {
            notify("Deleting...");
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deletePost', postId }) });
                if(await res.text() === "Success") {
                    notify("Tea deleted! ðŸ’¨");
                    loadMyPosts();
                }
            } catch (e) { notify("Delete failed."); }
        }

        function showLogoutConfirm() {
            showConfirm("Logout?", "End your current class session and clear local data? You will need to log in again.", () => {
                localStorage.clear();
                location.href = 'index.html';
            });
        }
    </script>
</body>
</html>